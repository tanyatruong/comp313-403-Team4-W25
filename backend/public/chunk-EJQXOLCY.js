import{H as d,Za as a,a as c,h as g,i as u,j as i,k as s,n as h,o as p,r as m,t as n,ub as o,vb as f,wb as v}from"./chunk-U7H4PKKY.js";var U=class l{constructor(e,t,r){this.platformId=e;this.apiService=t;this.authService=r;this.getLoggedInUser()}loggedInUser=null;users=[];login(e,t){return this.apiService.login(e,t).pipe(p(r=>{r.user&&(this.loggedInUser=this.mapMongoUser(r.user),a(this.platformId)&&(o.setItem("currentUser",JSON.stringify(this.loggedInUser)),r.token?(this.authService.setToken(r.token),console.log("Token stored in localStorage")):console.error("No token received from authentication response")))}),i(r=>({success:!!r?.user,user:r?.user,token:r?.token})),s(r=>(console.error("Authentication error:",r),g({success:!1}))))}getLoggedInUser(){if(this.loggedInUser)return this.loggedInUser;if(a(this.platformId)){let e=o.getItem("currentUser");if(e)return this.loggedInUser=JSON.parse(e),this.loggedInUser}return null}isAuthenticated(){return!!this.authService.getToken()&&!!this.getLoggedInUser()}logout(){this.loggedInUser=null,a(this.platformId)&&(o.removeItem("currentUser"),this.authService.clearToken())}getUserById(e){return this.apiService.get(`/users/${e}`).pipe(i(t=>this.mapMongoUser(t)),s(t=>this.handleApiError("loading user",t)))}getHrUsers(){return this.apiService.get("/users/hr").pipe(i(e=>e.map(t=>({id:t._id,username:t.name}))),h(1),s(e=>(e.status===401?console.debug("Authorization error while fetching HR users"):console.error("Error fetching HR users:",e),g([]))))}updateUser(e,t){return this.apiService.put(`/users/${e}`,t).pipe(i(r=>this.mapMongoUser(r)),p(r=>{this.updateUserCache(e,r),o.setItem("currentUser",JSON.stringify(this.loggedInUser))}),s(r=>this.handleApiError("updating users",r)))}mapMongoUser(e){return{_id:e._id,employeeNumber:e.employeeNumber,name:e.name,email:e.email,phone:e.phone,role:e.role,employeeId:e.employeeId,createdAt:new Date(e.createdAt)}}handleApiError(e,t){return console.error(`Error ${e}:`,t),u(()=>new Error(`Failed to ${e}`))}updateUserCache(e,t){let r=this.users.findIndex(I=>I._id?.toString()===e.toString());r!==-1&&(this.users[r]=c(c({},this.users[r]),t))}removeFromCache(e){this.users=this.users.filter(t=>t._id?.toString()!==e.toString())}static \u0275fac=function(t){return new(t||l)(n(d),n(v),n(f))};static \u0275prov=m({token:l,factory:l.\u0275fac,providedIn:"root"})};export{U as a};
