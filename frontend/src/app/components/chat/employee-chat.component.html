<!-- Modern Employee Chat -->
<button class="chat-toggle" (click)="toggleChat()">
  <i class="pi pi-comments"></i>
  <span class="badge" *ngIf="unreadMessages > 0">{{unreadMessages}}</span>
</button>

<div class="chat-panel" [class.open]="showChatPanel">
  <div class="chat-header">
    <span *ngIf="!selectedUser">Chat with HR</span>
    <span *ngIf="selectedUser">{{ selectedUser.name }} <small>({{ selectedUser.department }})</small></span>
    <div class="chat-actions">
      <button *ngIf="selectedUser" pButton icon="pi pi-arrow-left" class="p-button-text p-button-rounded" (click)="selectedUser = null"></button>
      <button pButton icon="pi pi-times" class="p-button-text p-button-rounded" (click)="showChatPanel = false"></button>
    </div>
  </div>

  <!-- User list view when no chat is selected -->
  <div *ngIf="!selectedUser" class="user-list-container">
    <div class="user-list-header">
      <h3>Available HR Representatives</h3>
    </div>
    <div class="user-list-content">
      <div *ngIf="activeHrUsers.length === 0" class="empty-state">
        <i class="pi pi-user-minus"></i>
        <p>No HR representatives are online.</p>
        <p>Please try again later or submit a ticket.</p>
      </div>

      <div *ngFor="let user of activeHrUsers" class="user-item" (click)="selectUser(user)">
        <div class="user-avatar">
          <i class="pi pi-user"></i>
        </div>
        <div class="user-info">
          <span class="user-name">{{ user.name }}</span>
          <span class="user-department">{{ user.department }}</span>
        </div>
        <div class="user-status">
          <span class="unread-badge" *ngIf="getUnreadCountForUser(user.id) > 0">{{getUnreadCountForUser(user.id)}}</span>
          <span class="status-dot online"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat view when a user is selected -->
  <div *ngIf="selectedUser" class="chat-main">
    <div class="message-container" #messageContainer>
      <div *ngIf="messages.length === 0" class="empty-chat">
        <i class="pi pi-comments"></i>
        <p>No messages yet</p>
        <p>Start a conversation with {{ selectedUser.name }}</p>
      </div>

      <div *ngFor="let message of messages" class="message" [class.outgoing]="message.sender === currentUser?._id" [class.incoming]="message.sender !== currentUser?._id">
        <div class="message-content">
          {{ message.message }}
          <span class="message-time">
            {{ message.createdAt | date:'shortTime' }}
            <i *ngIf="message.sender === currentUser?._id" class="pi" [ngClass]="{'pi-check': !message.read, 'pi-check-circle': message.read}"></i>
          </span>
        </div>
      </div>

      <div *ngIf="partnerIsTyping" class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <div class="message-input-container">
      <textarea pInputTextarea [(ngModel)]="newMessage" (input)="onMessageInput()" placeholder="Type a message..." [rows]="1" (keydown.enter)="sendMessage(); $event.preventDefault()"></textarea>
      <button pButton type="button" icon="pi pi-send" [disabled]="!newMessage.trim()" (click)="sendMessage()"></button>
    </div>
  </div>
</div>

<div class="chat-overlay" [class.active]="showChatPanel" (click)="showChatPanel = false"></div>